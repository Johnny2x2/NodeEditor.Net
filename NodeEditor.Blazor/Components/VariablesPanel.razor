@using NodeEditor.Blazor.Models
@using NodeEditor.Blazor.ViewModels
@implements IDisposable

<div class="ne-variables-panel @(_isCollapsed ? "ne-variables-panel--collapsed" : "")">
    <div class="ne-variables-header" @onclick="ToggleCollapse">
        <span class="ne-variables-header-icon">@(_isCollapsed ? "▶" : "▼")</span>
        Variables
        @if (!_isCollapsed)
        {
            <button class="ne-variables-add-btn" @onclick="OpenAddForm" @onclick:stopPropagation="true" title="Add Variable">+</button>
        }
    </div>

    @if (!_isCollapsed)
    {
        @if (_isAddingNew)
        {
            <div class="ne-variables-add-form">
                <input class="ne-variables-input"
                       @bind="_newVariableName"
                       @bind:event="oninput"
                       placeholder="Variable name"
                       @onkeydown="OnAddKeyDown" />
                <select class="ne-variables-select" @bind="_newVariableType">
                    <option value="System.Double">Number</option>
                    <option value="System.Int32">Integer</option>
                    <option value="System.String">String</option>
                    <option value="System.Boolean">Boolean</option>
                    <option value="System.Object">Object</option>
                </select>
                <div class="ne-variables-add-actions">
                    <button class="ne-variables-btn ne-variables-btn--confirm" @onclick="ConfirmAdd">Add</button>
                    <button class="ne-variables-btn ne-variables-btn--cancel" @onclick="CancelAdd">Cancel</button>
                </div>
            </div>
        }

        @if (State.Variables.Count == 0 && !_isAddingNew)
        {
            <div class="ne-variables-empty">No variables defined. Click + to add one.</div>
        }

        <div class="ne-variables-list">
            @foreach (var variable in State.Variables)
            {
                <div class="ne-variables-item"
                     draggable="true"
                     @ondragstart="@(e => OnVariableDragStart(e, variable))"
                     @ondragstart:stopPropagation="true"
                     title="Drag to canvas to create a Get node. Hold Alt while dropping for Set node.">

                    @if (_editingVariableId == variable.Id)
                    {
                        <input class="ne-variables-input ne-variables-input--inline"
                               @bind="_editVariableName"
                               @bind:event="oninput"
                               @onkeydown="OnEditKeyDown"
                               @onblur="SaveEdit" />
                    }
                    else
                    {
                        <span class="ne-variables-name" @ondblclick="@(() => StartEdit(variable))">
                            @variable.Name
                        </span>
                    }

                    <span class="ne-variables-type-badge ne-variables-type-badge--@GetTypeClass(variable.TypeName)">
                        @GetTypeFriendlyName(variable.TypeName)
                    </span>

                    <button class="ne-variables-delete-btn"
                            @onclick="@(() => DeleteVariable(variable.Id))"
                            @onclick:stopPropagation="true"
                            title="Delete variable">✕</button>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public NodeEditorState State { get; set; } = null!;

    /// <summary>
    /// Callback invoked when a variable drag starts, passing the variable ID and the drag event args.
    /// The parent canvas uses this to know what variable to place on drop.
    /// </summary>
    [Parameter]
    public EventCallback<VariableDragData> OnVariableDrag { get; set; }

    private bool _isCollapsed;
    private bool _isAddingNew;
    private string _newVariableName = "";
    private string _newVariableType = "System.Double";

    private string? _editingVariableId;
    private string _editVariableName = "";

    protected override void OnInitialized()
    {
        State.VariableAdded += OnStateChanged;
        State.VariableRemoved += OnStateChanged;
        State.VariableChanged += OnStateChanged;
    }

    public void Dispose()
    {
        State.VariableAdded -= OnStateChanged;
        State.VariableRemoved -= OnStateChanged;
        State.VariableChanged -= OnStateChanged;
    }

    private void OnStateChanged(object? sender, EventArgs e) => StateHasChanged();

    private void ToggleCollapse() => _isCollapsed = !_isCollapsed;

    // ===== Add Variable =====

    private void OpenAddForm()
    {
        _isAddingNew = true;
        _newVariableName = "";
        _newVariableType = "System.Double";
    }

    private void CancelAdd()
    {
        _isAddingNew = false;
    }

    private void ConfirmAdd()
    {
        var name = _newVariableName?.Trim();
        if (string.IsNullOrWhiteSpace(name))
            return;

        // Ensure unique name
        var baseName = name;
        var counter = 1;
        while (State.Variables.Any(v => v.Name.Equals(name, StringComparison.OrdinalIgnoreCase)))
        {
            name = $"{baseName} ({counter++})";
        }

        var defaultValue = GetDefaultValueForType(_newVariableType);
        var variable = GraphVariable.Create(name, _newVariableType, defaultValue);
        State.AddVariable(variable);

        _isAddingNew = false;
    }

    private void OnAddKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") ConfirmAdd();
        else if (e.Key == "Escape") CancelAdd();
    }

    // ===== Edit Variable =====

    private void StartEdit(GraphVariable variable)
    {
        _editingVariableId = variable.Id;
        _editVariableName = variable.Name;
    }

    private void SaveEdit()
    {
        if (_editingVariableId is null) return;

        var variable = State.FindVariable(_editingVariableId);
        if (variable is null) { _editingVariableId = null; return; }

        var newName = _editVariableName?.Trim();
        if (string.IsNullOrWhiteSpace(newName))
        {
            _editingVariableId = null;
            return;
        }

        if (newName != variable.Name)
        {
            State.UpdateVariable(variable with { Name = newName });
        }

        _editingVariableId = null;
    }

    private void OnEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") SaveEdit();
        else if (e.Key == "Escape") _editingVariableId = null;
    }

    // ===== Delete Variable =====

    private void DeleteVariable(string variableId)
    {
        State.RemoveVariable(variableId);
    }

    // ===== Drag =====

    private async Task OnVariableDragStart(DragEventArgs e, GraphVariable variable)
    {
        // Set drag data for the canvas drop handler
        e.DataTransfer.DropEffect = "copy";
        e.DataTransfer.EffectAllowed = "copy";

        if (OnVariableDrag.HasDelegate)
        {
            await OnVariableDrag.InvokeAsync(new VariableDragData(variable.Id, variable.Name));
        }
    }

    // ===== Helpers =====

    private static SocketValue? GetDefaultValueForType(string typeName) => typeName switch
    {
        "System.Double" => SocketValue.FromObject(0.0),
        "System.Int32" => SocketValue.FromObject(0),
        "System.String" => SocketValue.FromObject(""),
        "System.Boolean" => SocketValue.FromObject(false),
        _ => null
    };

    private static string GetTypeFriendlyName(string typeName) => typeName switch
    {
        "System.Double" => "Num",
        "System.Int32" => "Int",
        "System.String" => "Str",
        "System.Boolean" => "Bool",
        "System.Object" => "Obj",
        _ => typeName.Split('.').Last()
    };

    private static string GetTypeClass(string typeName) => typeName switch
    {
        "System.Double" => "number",
        "System.Int32" => "int",
        "System.String" => "string",
        "System.Boolean" => "bool",
        "System.Object" => "object",
        _ => "unknown"
    };
}

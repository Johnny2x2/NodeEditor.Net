@using NodeEditor.Blazor.Services
@using NodeEditor.Blazor.ViewModels

<div class="ne-node @(Node.IsSelected ? "ne-node--selected" : "")"
     style="@NodeStyle"
     @onpointerdown="OnNodePointerDown"
     @onpointerdown:stopPropagation
     @key="Node.Data.Id">
    
    <div class="ne-node-header">
        @if (Node.Data.Callable)
        {
            <span class="ne-node-exec-icon" title="Callable node">â–¶</span>
        }
        <span class="ne-node-title">@Node.Data.Name</span>
    </div>

    <div class="ne-node-body">
        @* Input sockets on the left *@
        <div class="ne-node-inputs">
            @foreach (var input in Node.Inputs)
            {
                <SocketComponent Socket="input"
                                 NodeId="@Node.Data.Id"
                                 OnPointerDown="@OnSocketPointerDown"
                                 OnPointerUp="@OnSocketPointerUp"
                                 @key="@($"in-{input.Data.Name}")" />
            }
        </div>

        @* Output sockets on the right *@
        <div class="ne-node-outputs">
            @foreach (var output in Node.Outputs)
            {
                <SocketComponent Socket="output"
                                 NodeId="@Node.Data.Id"
                                 OnPointerDown="@OnSocketPointerDown"
                                 OnPointerUp="@OnSocketPointerUp"
                                 @key="@($"out-{output.Data.Name}")" />
            }
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public NodeViewModel Node { get; set; } = null!;

    [Parameter]
    public EventCallback<SocketPointerEventArgs> OnSocketPointerDown { get; set; }

    [Parameter]
    public EventCallback<SocketPointerEventArgs> OnSocketPointerUp { get; set; }

    [CascadingParameter]
    private NodeEditorState? EditorState { get; set; }

    private string NodeStyle =>
        $"left: {Node.Position.X}px; top: {Node.Position.Y}px; " +
        $"width: {Node.Size.Width}px; min-height: {Node.Size.Height}px;";

    private void OnNodePointerDown(PointerEventArgs e)
    {
        if (e.Button == 0 && EditorState is not null)
        {
            // Ctrl+click for multi-select, otherwise single select
            if (e.CtrlKey)
            {
                EditorState.ToggleSelectNode(Node.Data.Id);
            }
            else
            {
                EditorState.SelectNode(Node.Data.Id, clearExisting: true);
            }
        }
    }
}

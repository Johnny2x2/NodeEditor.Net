@inject NodeRegistryService Registry
@implements IDisposable

@if (IsOpen)
{
        <div class="ne-context-menu"
            style="@MenuStyle"
            @onkeydown="OnKeyDown"
            @onkeydown:stopPropagation
            @onpointerdown:stopPropagation
            @onwheel:stopPropagation
            tabindex="0"
            @ref="_menuRef">
        <ContextMenuSearch @ref="_searchRef" Value="@_search" ValueChanged="OnSearchChanged" />
        <div class="ne-context-menu-list">
            @if (_catalog.Categories.Count == 0)
            {
                <div class="ne-context-menu-empty">No nodes found.</div>
            }
            else
            {
                @foreach (var category in _catalog.Categories)
                {
                    @RenderCategory(category, 0)
                }
            }
        </div>
    </div>
}

@code {
    private ElementReference _menuRef;
    private NodeCatalog _catalog = NodeCatalog.Create(Array.Empty<NodeDefinition>());
    private string _search = string.Empty;
    private bool _focusPending;
    private ContextMenuSearch? _searchRef;

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public Point2D Position { get; set; }

    [Parameter]
    public EventCallback<NodeDefinition> OnSelect { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private string MenuStyle => $"left: {Position.X}px; top: {Position.Y}px;";

    protected override void OnInitialized()
    {
        Registry.RegistryChanged += OnRegistryChanged;
        Registry.EnsureInitialized();
        RefreshCatalog();
    }

    protected override void OnParametersSet()
    {
        if (IsOpen)
        {
            _focusPending = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_focusPending && IsOpen)
        {
            _focusPending = false;
            try
            {
                if (_searchRef is not null)
                {
                    await _searchRef.FocusAsync();
                }
                else
                {
                    await _menuRef.FocusAsync();
                }
            }
            catch (JSException)
            {
                // Ignore focus errors if the element is no longer available.
            }
        }
    }

    public void Dispose()
    {
        Registry.RegistryChanged -= OnRegistryChanged;
    }

    private void OnRegistryChanged(object? sender, EventArgs e)
    {
        RefreshCatalog();
        InvokeAsync(StateHasChanged);
    }

    private void RefreshCatalog()
    {
        _catalog = Registry.GetCatalog(_search);
    }

    private async Task OnSearchChanged(string value)
    {
        _search = value;
        RefreshCatalog();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnSelectDefinition(NodeDefinition definition)
    {
        if (OnSelect.HasDelegate)
        {
            await OnSelect.InvokeAsync(definition);
        }

        await CloseAsync();
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await CloseAsync();
        }
    }

    private async Task CloseAsync()
    {
        _search = string.Empty;
        RefreshCatalog();

        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    private RenderFragment RenderCategory(NodeCategoryGroup category, int depth) => builder =>
    {
        var seq = 0;
        var categoryClass = depth == 0
            ? "ne-context-menu-category"
            : "ne-context-menu-category ne-context-menu-category--nested";

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", categoryClass);
        builder.AddAttribute(seq++, "style", $"--ne-category-depth: {depth};");

        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "ne-context-menu-category-title");
        builder.AddContent(seq++, category.Name);
        builder.CloseElement();

        if (category.Nodes.Count > 0)
        {
            builder.OpenElement(seq++, "div");
            builder.AddAttribute(seq++, "class", "ne-context-menu-category-items");

            foreach (var definition in category.Nodes)
            {
                builder.OpenComponent<ContextMenuItem>(seq++);
                builder.AddAttribute(seq++, nameof(ContextMenuItem.Definition), definition);
                builder.AddAttribute(seq++, nameof(ContextMenuItem.OnSelect),
                    EventCallback.Factory.Create<NodeDefinition>(this, OnSelectDefinition));
                builder.CloseComponent();
            }

            builder.CloseElement();
        }

        if (category.Children.Count > 0)
        {
            foreach (var child in category.Children)
            {
                builder.AddContent(seq++, RenderCategory(child, depth + 1));
            }
        }

        builder.CloseElement();
    };
}

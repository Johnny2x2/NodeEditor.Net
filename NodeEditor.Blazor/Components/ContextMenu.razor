@inject INodeRegistryService Registry
@inject IJSRuntime JSRuntime
@implements IDisposable
@implements IAsyncDisposable

@if (IsOpen)
{
        <div class="ne-context-menu"
            style="@MenuStyle"
            @onkeydown="OnKeyDown"
            @onkeydown:stopPropagation
            @onpointerdown:stopPropagation
            @onwheel:stopPropagation
            tabindex="0"
            @ref="_menuRef">
        <ContextMenuSearch @ref="_searchRef" Value="@_search" ValueChanged="OnSearchChanged" />
        <div class="ne-context-menu-list">
            @if (!string.IsNullOrWhiteSpace(_search))
            {
                @if (_catalog.All.Count == 0)
                {
                    <div class="ne-context-menu-empty">No nodes found.</div>
                }
                else
                {
                    <div class="ne-context-menu-category-items">
                        @foreach (var definition in _catalog.All)
                        {
                            <ContextMenuItem Definition="definition"
                                            OnSelect="OnSelectDefinition" />
                        }
                    </div>
                }
            }
            else if (_catalog.Categories.Count == 0)
            {
                <div class="ne-context-menu-empty">No nodes found.</div>
            }
            else
            {
                @if (_categoryStack.Count > 0)
                {
                    <button class="ne-context-menu-back" @onclick="NavigateUp">‚Üê Back</button>
                }

                @if (_categoryStack.Count > 0 && _categoryStack[^1].Nodes.Count > 0)
                {
                    <div class="ne-context-menu-category-items">
                        @foreach (var definition in _categoryStack[^1].Nodes)
                        {
                            <ContextMenuItem Definition="definition"
                                            OnSelect="OnSelectDefinition" />
                        }
                    </div>
                }

                @foreach (var category in CurrentCategories)
                {
                    @RenderCategory(category)
                }
            }
        </div>
    </div>
}

@code {
    private ElementReference _menuRef;
    private NodeCatalog _catalog = NodeCatalog.Create(Array.Empty<NodeDefinition>());
    private string _search = string.Empty;
    private bool _focusPending;
    private bool _positionPending;
    private ContextMenuSearch? _searchRef;
    private readonly List<NodeCategoryGroup> _categoryStack = new();

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public Point2D Position { get; set; }

    [Parameter]
    public EventCallback<NodeDefinition> OnSelect { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private string MenuStyle => $"left: {Position.X}px; top: {Position.Y}px;";

    protected override void OnInitialized()
    {
        Registry.RegistryChanged += OnRegistryChanged;
        Registry.EnsureInitialized();
        RefreshCatalog();
    }

    protected override void OnParametersSet()
    {
        if (IsOpen)
        {
            _focusPending = true;
            _positionPending = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_focusPending && IsOpen)
        {
            _focusPending = false;
            try
            {
                if (_searchRef is not null)
                {
                    await _searchRef.FocusAsync();
                }
                else
                {
                    await _menuRef.FocusAsync();
                }
            }
            catch (JSException)
            {
                // Ignore focus errors if the element is no longer available.
            }
        }

        if (_positionPending && IsOpen)
        {
            _positionPending = false;
            await UpdateMenuPositionAsync();
        }
    }

    public void Dispose()
    {
        Registry.RegistryChanged -= OnRegistryChanged;
    }

    private void OnRegistryChanged(object? sender, EventArgs e)
    {
        RefreshCatalog();
        InvokeAsync(StateHasChanged);
    }

    private void RefreshCatalog()
    {
        _catalog = Registry.GetCatalog(_search);
        _categoryStack.Clear();
    }

    private async Task OnSearchChanged(string value)
    {
        _search = value;
        RefreshCatalog();
        _positionPending = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnSelectDefinition(NodeDefinition definition)
    {
        if (OnSelect.HasDelegate)
        {
            await OnSelect.InvokeAsync(definition);
        }

        await CloseAsync();
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            if (_categoryStack.Count > 0)
            {
                NavigateUp();
            }
            else
            {
                await CloseAsync();
            }
        }
    }

    private async Task CloseAsync()
    {
        _search = string.Empty;
        RefreshCatalog();
        _positionPending = false;

        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    private IReadOnlyList<NodeCategoryGroup> CurrentCategories
        => _categoryStack.Count == 0
            ? _catalog.Categories
            : _categoryStack[^1].Children;

    private void NavigateInto(NodeCategoryGroup category)
    {
        _categoryStack.Add(category);
    }

    private void NavigateUp()
    {
        if (_categoryStack.Count > 0)
        {
            _categoryStack.RemoveAt(_categoryStack.Count - 1);
        }
    }

    private RenderFragment RenderCategory(NodeCategoryGroup category) => builder =>
    {
        var seq = 0;
        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "ne-context-menu-category");

        builder.OpenElement(seq++, "button");
        builder.AddAttribute(seq++, "type", "button");
        builder.AddAttribute(seq++, "class", "ne-context-menu-category-title");
        builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create(this, () => NavigateInto(category)));
        builder.AddContent(seq++, category.Name);
        builder.CloseElement();

        builder.CloseElement();
    };
}

@page "/"
@using NodeEditor.Blazor.Components
@using NodeEditor.Blazor.Models
@using NodeEditor.Blazor.Services
@using NodeEditor.Blazor.ViewModels
@using NodeEditor.Blazor.Services.Execution
@inject NodeEditorState EditorState
@inject NodeExecutionService ExecutionService

<div class="node-editor-toolbar">
    <button @onclick="StartExecutionAsync" disabled="@_isExecuting">Start</button>
    <button @onclick="StopExecution" disabled="@(!_isExecuting)">Stop</button>
    <span class="execution-status">@_executionStatus</span>
    @if (!string.IsNullOrWhiteSpace(_lastMessage))
    {
        <span class="execution-message">@_lastMessage</span>
    }
</div>

<NodePropertiesPanel State="EditorState" />

<div class="node-editor-container">
    <NodeEditorCanvas State="EditorState" />
</div>

@code {
    private CancellationTokenSource? _executionCts;
    private bool _isExecuting;
    private string _executionStatus = "Idle";
    private string? _lastMessage;
    private readonly SampleNodeContext _nodeContext = new();

    protected override void OnInitialized()
    {
        // Add some sample nodes for testing
        if (EditorState.Nodes.Count == 0)
        {
            CreateSampleGraph();
        }
    }

    private async Task StartExecutionAsync()
    {
        if (_isExecuting)
        {
            return;
        }

        _isExecuting = true;
        _executionStatus = "Running";
        _lastMessage = null;
        _nodeContext.Reset();

        _executionCts?.Dispose();
        _executionCts = new CancellationTokenSource();

        var context = new NodeExecutionContext();

        try
        {
            await ExecutionService.ExecuteAsync(
                EditorState.Nodes.Select(n => n.Data).ToList(),
                EditorState.Connections.ToList(),
                context,
                _nodeContext,
                null,
                _executionCts.Token).ConfigureAwait(false);

            _executionStatus = "Completed";
        }
        catch (OperationCanceledException)
        {
            _executionStatus = "Canceled";
        }
        catch (Exception ex)
        {
            _executionStatus = $"Failed: {ex.Message}";
        }
        finally
        {
            _isExecuting = false;
            _lastMessage = _nodeContext.LastMessage;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void StopExecution()
    {
        if (!_isExecuting)
        {
            return;
        }

        _executionStatus = "Canceling";
        _executionCts?.Cancel();
    }

    private void CreateSampleGraph()
    {
        // Node 1: Start node
        var startNode = new NodeViewModel(new NodeData(
            Id: "node-start",
            Name: "Start",
            Callable: true,
            ExecInit: true,
            Inputs: Array.Empty<SocketData>(),
            Outputs: new[]
            {
                new SocketData("ExecOut", "execution", false, true)
            }))
        {
            Position = new Point2D(50, 100)
        };

        // Node 2: Add operation
        var valueANode = new NodeViewModel(new NodeData(
            Id: "node-value-a",
            Name: "Value",
            Callable: false,
            ExecInit: false,
            Inputs: new[]
            {
                new SocketData("Value", "int", true, false)
            },
            Outputs: new[]
            {
                new SocketData("Value", "int", false, false)
            }))
        {
            Position = new Point2D(200, 20)
        };

        var valueBNode = new NodeViewModel(new NodeData(
            Id: "node-value-b",
            Name: "Value",
            Callable: false,
            ExecInit: false,
            Inputs: new[]
            {
                new SocketData("Value", "int", true, false)
            },
            Outputs: new[]
            {
                new SocketData("Value", "int", false, false)
            }))
        {
            Position = new Point2D(200, 120)
        };

        var addNode = new NodeViewModel(new NodeData(
            Id: "node-add",
            Name: "Add",
            Callable: false,
            ExecInit: false,
            Inputs: new[]
            {
                new SocketData("A", "int", true, false),
                new SocketData("B", "int", true, false)
            },
            Outputs: new[]
            {
                new SocketData("Result", "int", false, false)
            }))
        {
            Position = new Point2D(450, 70)
        };

        // Node 3: Print node
        var printNode = new NodeViewModel(new NodeData(
            Id: "node-print",
            Name: "Print",
            Callable: true,
            ExecInit: false,
            Inputs: new[]
            {
                new SocketData("ExecIn", "execution", true, true),
                new SocketData("Message", "string", true, false)
            },
            Outputs: new[]
            {
                new SocketData("ExecOut", "execution", false, true)
            }))
        {
            Position = new Point2D(300, 200)
        };

        // Node 4: Constant
        // Node 5: ToString
        var toStringNode = new NodeViewModel(new NodeData(
            Id: "node-tostring",
            Name: "ToString",
            Callable: false,
            ExecInit: false,
            Inputs: new[]
            {
                new SocketData("Input", "object", true, false)
            },
            Outputs: new[]
            {
                new SocketData("Output", "string", false, false)
            }))
        {
            Position = new Point2D(550, 100)
        };

        // Add all nodes
        EditorState.AddNode(startNode);
        EditorState.AddNode(valueANode);
        EditorState.AddNode(valueBNode);
        EditorState.AddNode(addNode);
        EditorState.AddNode(printNode);
        EditorState.AddNode(toStringNode);

        // Add connections
        EditorState.AddConnection(new ConnectionData("node-start", "node-print", "ExecOut", "ExecIn", true));
        EditorState.AddConnection(new ConnectionData("node-value-a", "node-add", "Value", "A", false));
        EditorState.AddConnection(new ConnectionData("node-value-b", "node-add", "Value", "B", false));
        EditorState.AddConnection(new ConnectionData("node-add", "node-tostring", "Result", "Input", false));
        EditorState.AddConnection(new ConnectionData("node-tostring", "node-print", "Output", "Message", false));
    }

    private sealed class SampleNodeContext : INodeMethodContext
    {
        public NodeData? CurrentProcessingNode { get; set; }

        public event Action<string, NodeData, ExecutionFeedbackType, object?, bool>? FeedbackInfo;

        public string? LastMessage { get; private set; }

        public void Reset()
        {
            LastMessage = null;
        }

        [Node("Start", isCallable: true, isExecutionInitiator: true)]
        public void Start(out ExecutionPath ExecOut)
        {
            ExecOut = new ExecutionPath();
            ExecOut.Signal();
        }

        [Node("Add", isCallable: false)]
        public void Add(int A, int B, out int Result)
        {
            Result = A + B;
        }

        [Node("Print", isCallable: true)]
        public void Print(ExecutionPath ExecIn, string Message, out ExecutionPath ExecOut)
        {
            LastMessage = Message;
            ExecOut = new ExecutionPath();
            ExecOut.Signal();
        }

        [Node("Value", isCallable: false)]
        public void Value(int Value, out int Output)
        {
            Output = Value;
        }

        [Node("ToString", isCallable: false)]
        public void ToStringNode(object Input, out string Output)
        {
            Output = Input?.ToString() ?? string.Empty;
        }
    }
}
